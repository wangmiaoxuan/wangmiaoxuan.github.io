<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Google 認證與會員管理</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js"></script>
</head>
<body>
  <h1>Google 認證與會員管理</h1>
  <button id="register">註冊</button>
  <button id="login">登入</button>
  <div id="user-info" style="display: none;">
    <h2>會員資訊</h2>
    <img id="user-photo" alt="User Photo" style="width: 100px; height: 100px; border-radius: 50%;"><br>
    <span id="user-name"></span><br>
    <span id="user-email"></span><br>
    <span id="last-login"></span>
  </div>
  <script>
    // Firebase 配置
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_AUTH_DOMAIN",
      databaseURL: "YOUR_DATABASE_URL",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_STORAGE_BUCKET",
      messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
      appId: "YOUR_APP_ID"
    };
    const app = firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();

    const registerButton = document.getElementById('register');
    const loginButton = document.getElementById('login');
    const userInfo = document.getElementById('user-info');
    const userPhoto = document.getElementById('user-photo');
    const userName = document.getElementById('user-name');
    const userEmail = document.getElementById('user-email');
    const lastLogin = document.getElementById('last-login');

    // Google 認證
    const provider = new firebase.auth.GoogleAuthProvider();

    async function handleAuth(isRegistering) {
      try {
        const result = await auth.signInWithPopup(provider);
        const user = result.user;

        if (isRegistering) {
          // 註冊：將會員資料儲存至 Realtime Database
          const now = new Date().toISOString();
          await db.ref('users/' + user.uid).set({
            name: user.displayName,
            email: user.email,
            photoURL: user.photoURL,
            lastLogin: now
          });
        } else {
          // 登入：更新最後登入時間
          const now = new Date().toISOString();
          await db.ref('users/' + user.uid).update({ lastLogin: now });
        }

        // 顯示會員資訊
        const userData = (await db.ref('users/' + user.uid).get()).val();
        userPhoto.src = userData.photoURL;
        userName.textContent = `姓名: ${userData.name}`;
        userEmail.textContent = `Email: ${userData.email}`;
        lastLogin.textContent = `最後登入: ${userData.lastLogin}`;
        userInfo.style.display = 'block';
      } catch (error) {
        console.error('認證失敗:', error.message);
      }
    }

    registerButton.addEventListener('click', () => handleAuth(true));
    loginButton.addEventListener('click', () => handleAuth(false));
  </script>
</body>
</html>
